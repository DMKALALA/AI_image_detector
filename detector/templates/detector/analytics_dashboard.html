{% extends 'detector/base.html' %}
{% load detector_extras %}

{% block title %}Analytics Dashboard - AI Image Detector{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'detector:home' %}">Home</a></li>
                        <li class="breadcrumb-item active">Analytics Dashboard</li>
                    </ol>
                </nav>
            </div>
        </div>
        
        <!-- Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3>{{ total_images }}</h3>
                        <p class="mb-0">Total Images</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3>{{ real_images }}</h3>
                        <p class="mb-0">Real Images</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h3>{{ ai_images }}</h3>
                        <p class="mb-0">AI Images</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3>{{ accuracy|floatformat:1 }}%</h3>
                        <p class="mb-0">Detection Accuracy</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Detection Distribution -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Detection Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="detectionChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Confidence Distribution -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Confidence Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="confidenceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Feedback and Activity Row -->
        <div class="row mb-4">
            <!-- Feedback Statistics -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-thumbs-up"></i> User Feedback</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4 text-center">
                                <h4 class="text-success">{{ correct_feedback }}</h4>
                                <small>Correct</small>
                            </div>
                            <div class="col-4 text-center">
                                <h4 class="text-danger">{{ incorrect_feedback }}</h4>
                                <small>Incorrect</small>
                            </div>
                            <div class="col-4 text-center">
                                <h4 class="text-warning">{{ unsure_feedback }}</h4>
                                <small>Unsure</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="progress">
                                {% if total_feedback > 0 %}
                                <div class="progress-bar bg-success" style="width: {% widthratio correct_feedback total_feedback 100 %}%"></div>
                                <div class="progress-bar bg-danger" style="width: {% widthratio incorrect_feedback total_feedback 100 %}%"></div>
                                <div class="progress-bar bg-warning" style="width: {% widthratio unsure_feedback total_feedback 100 %}%"></div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Feedback Rate: {{ feedback_rate|floatformat:1 }}%</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-clock"></i> Recent Activity (7 days)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center">
                                <h4 class="text-primary">{{ recent_uploads }}</h4>
                                <small>New Uploads</small>
                            </div>
                            <div class="col-6 text-center">
                                <h4 class="text-info">{{ recent_feedback }}</h4>
                                <small>New Feedback</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <canvas id="activityChart" width="400" height="150"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Method Statistics -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cogs"></i> Detection Methods</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for method in method_stats %}
                            <div class="col-md-3 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6>{{ method.method|title }}</h6>
                                        <h4 class="text-primary">{{ method.count }}</h4>
                                        <small>{% widthratio method.count total_images 100 %}%</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Confidence Analysis -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Confidence Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">{{ high_confidence }}</h4>
                                    <small>High Confidence (80%+)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">{{ medium_confidence }}</h4>
                                    <small>Medium Confidence (50-80%)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-danger">{{ low_confidence }}</h4>
                                    <small>Low Confidence (<50%)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">{{ avg_confidence_percentage|floatformat:1 }}%</h4>
                                    <small>Average Confidence</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Confidence Ranges Chart -->
                        <div class="mt-4">
                            <canvas id="confidenceRangesChart" width="800" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Detection Distribution Chart
    const detectionCtx = document.getElementById('detectionChart').getContext('2d');
    new Chart(detectionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Real Images', 'AI Images'],
            datasets: [{
                data: [{{ real_images }}, {{ ai_images }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Confidence Distribution Chart
    const confidenceCtx = document.getElementById('confidenceChart').getContext('2d');
    new Chart(confidenceCtx, {
        type: 'bar',
        data: {
            labels: ['High', 'Medium', 'Low'],
            datasets: [{
                label: 'Images',
                data: [{{ high_confidence }}, {{ medium_confidence }}, {{ low_confidence }}],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Activity Chart
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    const dailyData = {{ daily_uploads|safe }};
    new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: dailyData.map(d => d.date).reverse(),
            datasets: [{
                label: 'Daily Uploads',
                data: dailyData.map(d => d.count).reverse(),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Confidence Ranges Chart
    const confidenceRangesCtx = document.getElementById('confidenceRangesChart').getContext('2d');
    const rangesData = {{ confidence_ranges|safe }};
    new Chart(confidenceRangesCtx, {
        type: 'bar',
        data: {
            labels: rangesData.map(r => r.range),
            datasets: [{
                label: 'Images',
                data: rangesData.map(r => r.count),
                backgroundColor: [
                    '#dc3545', '#fd7e14', '#ffc107', '#20c997', '#28a745'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}
